<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link th:href="@{/css/navbar.css}" rel="stylesheet">
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">

    <style>
        table {
            border-spacing: 0;
            width: 100%;
            border: 1px solid #ddd;
        }

        th, td {
            text-align: left;

        }

        tr:nth-child(even) {
            background-color: #f2f2f2
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>

</head>
<body>
<header th:replace="~{fragments.html :: navbar}"></header>

<!--
<div class="container">
<div class="form-container">
    <h2> Opret en ny bil </h2>
    <form class="form2" th:action="@{/createCar}" method="post">
        <label for="car-model-id">Model id:</label>
        <input type="text" id="car-model-id" name="car-model-id" placeholder="Indtast bilens model id" required>

        <label for="vin-number">Stelnummer:</label>
        <input type="text" id="vin-number" name="vin-number" placeholder="Indtast bilens stelnummer" required>

        <label for="color">Indtast bilens farve:</label>
        <input type="text" id="color" name="color" placeholder="Indtast bilens farve" required>

        <button type="submit"> Opret bil </button>

    </form>
</div>
</div>
-->

<label for="tableSelector">Choose a table:</label>
<select id="tableSelector">
    <option value="lease" th:if="${session.loggedInUser.getRoleValue().equalsIgnoreCase('ADMIN') ||
                                   session.loggedInUser.getRoleValue().equalsIgnoreCase('DATA_RECORDING')}">
        Leasingaftaler
    </option>
    <option value="lease_inactive" th:if="${session.loggedInUser.getRoleValue().equalsIgnoreCase('ADMIN') ||
                                   session.loggedInUser.getRoleValue().equalsIgnoreCase('DATA_RECORDING')}">
        Færdige leasingaftaler
    </option>
    <option value="car" th:if="${!session.loggedInUser.getRoleValue().equalsIgnoreCase('BUSINESS_DEVELOPER')}">
        Biler
    </option>
    <option value="condition_report" th:if="${session.loggedInUser.getRoleValue().equalsIgnoreCase('ADMIN') ||
                                   session.loggedInUser.getRoleValue().equalsIgnoreCase('MECHANIC')}">
        Tilstandsrapporter
    </option>
    <option value="damage" th:if="${session.loggedInUser.getRoleValue().equalsIgnoreCase('ADMIN') ||
                                   session.loggedInUser.getRoleValue().equalsIgnoreCase('MECHANIC')}">
        Skader
    </option>
    <option value="employee" th:if="${session.loggedInUser.getRoleValue().equalsIgnoreCase('ADMIN')}">
        Ansatte
    </option>
    <option value="purchase_agreements" th:if="${session.loggedInUser.getRoleValue().equalsIgnoreCase('ADMIN') ||
                                   session.loggedInUser.getRoleValue().equalsIgnoreCase('DATA_RECORDING')}">
        Købsaftaler
    </option>
    <option value="customer">
        Kunder
    </option>
</select>


<div>
    <input type="text" id="search" onkeyup="myFunction()" placeholder="Search..">
</div>
<div class="dataTable" id="lease">
<h2>Aktive leasing aftaler</h2>

    <table id="lease_table">
        <thead>
        <tr>
            <th onclick="sortTable(0)">Lease detaljer</th>
            <th onclick="sortTable(1)">Vin number</th>
            <th onclick="sortTable(2)">Customer Id</th>
            <th onclick="sortTable(3)">Lease Type</th>
            <th onclick="sortTable(4)">Lease Price</th>
            <th onclick="sortTable(5)">Lease Start Date</th>
            <th onclick="sortTable(6)">Lease End Date</th>
            <th onclick="sortTable(7)">Return Location</th>
            <th onclick="sortTable(8)">Delete</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each= "leaseAgreement: ${leaseAgreements}" th:if="${leaseAgreement.active}">
            <td>
                <form th:action="@{/leaseDetails}" method="get">
                    <input type="hidden" th:value="${leaseAgreement.leaseAgreementId}" name="lease_agreement_id">
                    <button type="submit"> Vis lease </button>
                </form>

                <td th:text="${leaseAgreement.getCar().getVinNumber()}" />
                <td th:text="${leaseAgreement.getCustomer().getCustomerId()}" />
                <td th:text="${leaseAgreement.leaseType}" />
                <td th:text="${leaseAgreement.leasePrice}" />
                <td th:text="${leaseAgreement.leaseStartDate}" />
                <td th:text="${leaseAgreement.leaseEndDate}" />
                <td th:text="${leaseAgreement.returnLocation}" />
            <td>
                <form th:action="@{/deleteLease}" method="post">
                    <input type="hidden" name="lease_agreement_id" th:value="${leaseAgreement.leaseAgreementId}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>


    </table>
    <div class="container">
        <div class="form-container">
            <h2> Opret en ny lease </h2>
            <form class="form2" th:action="@{/createLease}" method="post">
                <div class="form-field">
                    <label for="fk_vehicle_id">Vælge bil:</label>
                    <select id="vehicle-lease" name="vehicle-lease">
                        <option value=""> Vælg bil </option>
                        <option th:each="car : ${cars}" th:value="${car.vehicleId}" th:text="${ car.vehicleId+ ' '+ car.carModel.getBrand() + ' '+car.carModel.getCarEquipment()}"> </option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="fk_customer_id">Vælg kunde:</label>
                    <select id="fk_customer_id" name="fk_customer_id">
                        <option value="">Vælge kunde</option>
                        <option th:each="customer : ${customers}" th:value="${customer.getCustomerId()}" th:text="${ customer.customerId+' '+customer.firstName + ' ' + customer.lastName}"></option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="lease_type">Indtast lease type:</label>
                    <select id="lease_type" name="lease_type">
                        <option value=""> Indtast lease type </option>
                        <option th:each="type : ${leaseTypes}" th:value="${type}" th:text="${type}"> </option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="lease_price">Indtast lease pris:</label>
                    <input type="number" min="0" id="lease_price" name="lease_price" placeholder="Indtast lease pris" required>
                </div>

                <div class="form-field">
                    <label for="lease_start_date">Indtast startdato:</label>
                    <input type="date" id="lease_start_date" name="lease_start_date" placeholder="Indtast lease startdato" required>
                </div>

                <div class="form-field">
                    <label for="lease_end_date">Indtast slutdato:</label>
                    <input type="date" id="lease_end_date" name="lease_end_date" placeholder="Indtast lease slutdato" required>
                </div>

                <div class="form-field">
                    <label for="return_location">Indtast bilens returlocation:</label>
                    <input type="text" id="return_location" name="return_location" placeholder="Indtast bilens returlocation" required>
                </div>

                <div class="form-field">
                    <button type="submit" class="action-button"> Opret lease </button>
                </div>
            </form>
        </div>
    </div>



</div>

<div class="dataTable" id="lease_inactive">
<h2>Inaktive leasing aftaler</h2>
    <table id="lease_inactive_table">
        <thead>
        <tr>
            <th onclick="sortTable(0)">Lease detaljer</th>
            <th onclick="sortTable(1)">Vehicle Id</th>
            <th onclick="sortTable(2)">Customer Id</th>
            <th onclick="sortTable(3)">Lease Type</th>
            <th onclick="sortTable(4)">Lease Price</th>
            <th onclick="sortTable(5)">Lease Start Date</th>
            <th onclick="sortTable(6)">Lease End Date</th>
            <th onclick="sortTable(7)">Return Location</th>
            <th onclick="sortTable(8)">Delete</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each= "leaseAgreement: ${leaseAgreements}" th:if="${!leaseAgreement.active}">
            <td>
                <form th:action="@{/leaseDetails}" method="get">
                    <input type="hidden" th:value="${leaseAgreement.leaseAgreementId}" name="lease_agreement_id">
                    <button type="submit"> Vis lease </button>
                </form>
            </td>
            <td th:text="${leaseAgreement.fkVehicleId}" />
            <td th:text="${leaseAgreement.getCustomer().getCustomerId()}" />
            <td th:text="${leaseAgreement.leaseType}" />
            <td th:text="${leaseAgreement.leasePrice}" />
            <td th:text="${leaseAgreement.leaseStartDate}" />
            <td th:text="${leaseAgreement.leaseEndDate}" />
            <td th:text="${leaseAgreement.returnLocation}" />
            <td>
                <form th:action="@{/deleteLease}" method="post">
                    <input type="hidden" name="lease_agreement_id" th:value="${leaseAgreement.leaseAgreementId}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="dataTable" id="car">
<h2>Biler</h2>
    <table id="car_table">
        <thead>
            <tr>
                <th onclick="sortTable(0)">ID</th>
                <th onclick="sortTable(1)">VIN Number</th>
                <th onclick="sortTable(2)">Mærke</th>
                <th onclick="sortTable(3)">Model</th>
                <th onclick="sortTable(4)">Udstyr</th>
                <th onclick="sortTable(5)">Farve</th>
                <th onclick="sortTable(6)">Forkøbt</th>
                <th onclick="sortTable(7)">Status</th>
                <th onclick="sortTable(8)">Tilstandsrapport</th>
                <th onclick="sortTable(9)">Slet bil</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="car: ${cars}">
                <td th:text="${car.getVehicleId()}" />
                <td th:text="${car.vinNumber}" />
                <td th:text="${car.getCarModel().getBrand()}" />
                <td th:text="${car.getCarModel().getModelName()}" />
                <td th:text="${car.getCarModel().getCarEquipment()}" />
                <td th:text="${car.color}" />
                <td th:text="${car.bought}" />
                <td th:text="${car.statusValue}" />
                <td>
                    <div th:if="${conditionReportsMap[car.vehicleId] != null}">

                        <!-- If the condition report has been set as completed, you get a print button -->
                        <div th:if="${conditionReportsMap[car.vehicleId].completed}">
                            <form th:action="@{/condition-report}" method="get" target="_blank">
                                <input type="hidden" name="condition_report_id"
                                       th:value="${conditionReportsMap[car.vehicleId].conditionReportId}" />
                                <button type="submit" class="btn">Print tilstandsrapport</button>
                            </form>
                        </div>

                        <!-- If it is not completed, you get an edit button -->
                        <div th:unless="${conditionReportsMap[car.vehicleId].completed}">
                            <form th:action="@{/condition-report}" method="get">
                                <input type="hidden" name="condition_report_id"
                                       th:value="${conditionReportsMap[car.vehicleId].conditionReportId}" />
                                <button type="submit" class="btn">Rediger tilstandsrapport</button>
                            </form>
                        </div>

                    </div>
                            <!-- If non-existant, you get a create button -->
                    <div th:unless="${conditionReportsMap[car.vehicleId] != null}">
                        <form th:action="@{/createConditionReport}" method="post">
                            <input type="hidden" name="vehicle_id" th:value="${car.vehicleId}" />
                            <button type="submit">Opret tilstandsrapport</button>
                        </form>
                    </div>
                </td>
                <td>
                    <form th:action="@{/deleteCar}" method="post">
                        <input type="hidden" name="vehicleId" th:value="${car.vehicleId}">
                        <button type="submit">Delete</button>
                    </form>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div class="dataTable" id="condition_report">
<h2>Tilstandsrapporter</h2>
    <table id="condition_report_table">
        <thead>
        <tr>
            <th onclick="sortTable(0)">ID</th>
            <th onclick="sortTable(1)">Handler</th>
            <th onclick="sortTable(2)">Startdato</th>
            <th onclick="sortTable(3)">Slutdato</th>
            <th onclick="sortTable(4)">Delete</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="conditionReport: ${conditionReports}">
            <td th:text="${conditionReport.conditionReportId}" />
            <td th:text="${conditionReport.handledBy}" />
            <td th:text="${conditionReport.reportStartDate}" />
            <td th:text="${conditionReport.reportCompletedDate}" />
            <td>
                <form th:action="@{/deleteConditionReport}" method="post">
                    <input type="hidden" name="condition_report_id" th:value="${conditionReport.conditionReportId}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="dataTable" id="damage">
<h2>Skader</h2>
    <table id="damage_table">
        <thead>
        <tr>
            <th onclick="sortTable(0)">ID</th>
            <th onclick="sortTable(1)">Tilstandsrapport-ID</th>
            <th onclick="sortTable(2)">Pris</th>
            <th onclick="sortTable(3)">Type skade</th>
            <th onclick="sortTable(4)">Delete</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="damage: ${damages}">
            <td th:text="${damage.damageId}" />
            <td th:text="${damage.conditionReportId}" />
            <td th:text="${damage.damagePrice}" />
            <td th:text="${damage.damageType}" />
            <td>
                <form th:action="@{/deleteDamage}" method="post">
                    <input type="hidden" name="damageId" th:value="${damage.damageId}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="dataTable" id="employee">
<h2>Ansatte</h2>
    <table id="employee_table">
        <thead>
        <tr>
            <th onclick="sortTable(0)">ID</th>
            <th onclick="sortTable(1)">Fornavn</th>
            <th onclick="sortTable(2)">Efternavn</th>
            <th onclick="sortTable(3)">Shortname</th>
            <th onclick="sortTable(4)">Email</th>
            <th onclick="sortTable(5)">Rolle</th>
            <th onclick="sortTable(6)">Delete</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="employee: ${employees}">
            <td th:text="${employee.employeeId}" />
            <td th:text="${employee.firstName}" />
            <td th:text="${employee.lastName}" />
            <td th:text="${employee.shortName}" />
            <td th:text="${employee.email}" />
            <td th:text="${employee.getRole()}" />
            <td>
                <form th:action="@{/deleteEmployee}" method="post">
                    <input type="hidden" name="empployeeId" th:value="${employee.employeeId}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="dataTable" id="purchase_agreements">
<h2>Købsaftaler</h2>
    <table id="purchase_agreements_table">
        <thead>
        <tr>
            <th onclick="sortTable(0)">ID</th>
            <th onclick="sortTable(1)">Kunde id</th>
            <th onclick="sortTable(2)">Bil id</th>
            <th onclick="sortTable(3)">Pris</th>
            <th onclick="sortTable(4)">Betalt?</th>
            <th onclick="sortTable(5)">Delete</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="purchaseAgreement: ${purchaseAgreements}">
            <td th:text="${purchaseAgreement.purchaseAgreementId}" />
            <td th:text="${purchaseAgreement.fkCustomerId}" />
            <td th:text="${purchaseAgreement.fkVehicleId}" />
            <td th:text="${purchaseAgreement.carPrice}" />
            <td th:text="${purchaseAgreement.paid}" />
            <td>
                <form th:action="@{/deletePurchaseAgreement}" method="post">
                    <input type="hidden" name="purchaseAgreementId" th:value="${purchaseAgreement.purchaseAgreementId}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="dataTable" id="customer">
    <table id="customer_table">
        <h2>Kunder</h2>
        <thead>
        <tr>
            <th onclick="sortTable(0)">ID</th>
            <th onclick="sortTable(1)">Fornavn</th>
            <th onclick="sortTable(2)">Efternavn</th>
            <th onclick="sortTable(3)">Email</th>
            <th onclick="sortTable(4)">Cpr-nummer</th>
            <th onclick="sortTable(5)">TelefonNummer</th>
            <th onclick="sortTable(6)">Adresse</th>
            <th onclick="sortTable(7)">By</th>
            <th onclick="sortTable(8)">Postnummer</th>
            <th onclick="sortTable(9)">Bil id</th>
            <th onclick="sortTable(10)">Delete</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="customer: ${customers}">
            <td th:text="${customer.customerId}" />
            <td th:text="${customer.firstName}" />
            <td th:text="${customer.lastName}" />
            <td th:text="${customer.email}" />
            <td th:text="${customer.cprNumber}" />
            <td th:text="${customer.phoneNumber}" />
            <td th:text="${customer.address}" />
            <td th:text="${customer.city}" />
            <td th:text="${customer.postalCode}" />
            <td th:text="${customer.fkVehicleId}" />
            <td>
                <form th:action="@{/deleteCustomer}" method="post">
                    <input type="hidden" name="customerId" th:value="${customer.customerId}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="container">
        <div class="form-container">
            <h2> Opret en ny Kunde </h2>
            <form class="form2" th:action="@{/createLease}" method="post">
                <div class="form-field">
                    <label class="label-create"  for="first_name">Fornavn:</label>
                    <input type="text" id="first_name" name="first_name" placeholder="Indtast fornavn" required>
                </div>

                <div class="form-field">
                    <label class="label-create"  for="last_name">Efternavn:</label>
                    <input type="text" id="last_name" name="last_name" placeholder="Indtast efternavn" required>
                </div>
                <div class="form-field">
                    <label class="label-create" for="email">Email:</label>
                    <input type="email" id="email" name="email" placeholder="Indtast email:" required>
                </div>

                <div class="form-field">
                    <label class="label-create" for="phone_number">Telefon nummer:</label>
                    <input type="number" id="phone_number" name="phone_number" placeholder="Indtast mængde:" required>
                </div>

                <div class="form-field">
                    <label class="label-create" for="address">Adresse:</label>
                    <input type="text" id="address" name="address" placeholder="Indtast adresse" required>
                </div>

                <div class="form-field">
                    <label class="label-create"  for="city">By:</label>
                    <input type="text" id="city" name="city" placeholder="Indtast city" required>
                </div>

                <div class="form-field">
                    <label class="label-create" for="postal_code">Postnummer:</label>
                    <input type="number" id="postal_code" name="postal_code" placeholder="Indtast postnummer:" required>
                </div>

                <div class="form-field">
                    <label class="label-create" for="cpr_number">CPR-Nummer:</label>
                    <input type="text" id="cpr_number" name="cpr_number" placeholder="Indtast cpr:" required>
                </div>

                <div class="form-field">
                    <label for="fk_vehicle_id">Vælge bil:</label>
                    <select id="fk_vehicle_id" name="fk_vehicle_id">
                        <option value=""> Vælg bil </option>
                        <option th:each="car : ${cars}" th:value="${car.vehicleId}" th:text="${ car.vehicleId+ ' '+ car.carModel.getBrand() + ' '+car.carModel.getCarEquipment()}"> </option>
                    </select>
                </div>

                <div class="form-field">
                    <button type="submit" class="action-button"> Opret kunde </button>
                </div>

            </form>
        </div>
    </div>

</div>
</body>

<script>
    let tableId;
    $(document).ready(function () {
        // Cache the table selector
        const tableSelector = $('#tableSelector');

        // Initially hide all tables
        $('.dataTable').hide();

        // Show and initialize the default table
        tableId = tableSelector.val();
        $('#' + tableId).show();

        // On table selection change
        tableSelector.on('change', function ()  {
            tableId = $(this).val();

            // Hide all tables
            $('.dataTable').hide();

            // Show the selected table
            $('#' + tableId).show();
            console.log(tableId);
        });
    });

    function sortTable(n) {
        console.log('clicked')
        let table, rows, switching, i, x, y, shouldSwitch, dir, switchCount = 0;
        table = document.getElementById(`${tableId}_table`);
        console.log(table);
        switching = true;
        // Set the sorting direction to ascending:
        dir = "asc";

        // Make a loop that will continue until no switching has been done:
        while (switching) {
            // Start by saying: no switching is done:
            switching = false;
            rows = table.rows;
            /* Loop through all table rows (except the
            first, which contains table headers): */
            for (i = 1; i < (rows.length - 1); i++) {
                // Start by saying there should be no switching:
                shouldSwitch = false;
                // Get the two elements you want to compare, one from current row and one from the next:
                x = rows[i].getElementsByTagName("td")[n];
                y = rows[i + 1].getElementsByTagName("td")[n];

                //console.log(Number(x.innerHTML));
                if (Number(x.innerHTML)) {
                    console.log('number')
                }
                // Check if the two rows should switch place, based on the direction, asc or desc:
                if (dir === "asc") {
                    if (Number(x.innerHTML)){
                        if (Number(x.innerHTML) > Number(y.innerHTML)) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true;
                            break;
                        }
                    } else {
                        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true;
                            break;
                        }
                    }
                } else if (dir === "desc") {
                    if (Number(x.innerHTML)){
                        if (Number(x.innerHTML) < Number(y.innerHTML)) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true;
                            break;
                        }
                    } else {
                        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true;
                            break;
                        }
                    }
                }
            }
            if (shouldSwitch) {
                // If a switch has been marked, make the switch and mark that a switch has been done:
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                // Each time a switch is done, increase this count by 1:
                switchCount ++;
            } else {
                /* If no switching has been done AND the direction is "asc",
                set the direction to "desc" and run the while loop again. */
                if (switchCount === 0 && dir === "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }

    function myFunction() {
        // Declare variables
        let input, filter, table, rows, column, i, txtValue;
        input = document.getElementById("search");
        filter = input.value.toUpperCase();
        table = document.getElementById(`${tableId}_table`);
        rows = table.getElementsByTagName("tr");

        console.log(filter);

        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < rows.length; i++) {
            console.log(rows[i].cells.length);
            for (let l = 0; l < rows[i].cells.length; l++) {
                column = rows[i].getElementsByTagName("td")[l];
                if (column) {
                    txtValue = column.textContent || column.innerText;
                    console.log(txtValue);
                    console.log(txtValue.indexOf(filter));
                    if (txtValue.toUpperCase().indexOf(filter) === 0) {
                        rows[i].style.display = "";
                        break;
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }
        }
    }
</script>
</html>
